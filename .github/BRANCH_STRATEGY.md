# Branch Strategy Guide

## The CipherOcto Branching Model

We use **Trunk-Based Development + Feature Streams** to maintain velocity while keeping `main` always releasable.

```
                    ┌─────────────┐
                    │    main     │  ← Always releasable, PROTECTED
                    └──────┬──────┘
                           │ (PR only)
                    ┌──────▼──────┐
                    │    next     │  ← Integration lane
                    └──────┬──────┘
                           │ (PR or direct)
            ┌──────────────┼──────────────┐
            │              │              │
     ┌──────▼──────┐ ┌────▼─────┐ ┌─────▼──────┐
     │   feat/*    │ │ agent/*  │ │ research/* │
     └─────────────┘ └──────────┘ └────────────┘
        features      AI work      experiments

     ┌──────▼──────┐
     │  hotfix/*   │  → PR directly to main
     └─────────────┘
```

---

## Branch Types

### `main` — The Trunk
- **Status:** Always releasable
- **Protection:** Strict (no direct push)
- **Merge to:** PR from `next` or `hotfix/*`
- **CI:** Full suite required
- **Deploy:** Auto-deployed on merge

### `next` — Integration Lane
- **Status:** Mostly stable
- **Protection:** CI required, direct push OK
- **Purpose:** Integration testing before main
- **Merge to:** PR from `feat/*`, `agent/*`, `research/*`
- **Deploy:** Staging environment

### `feat/*` — Feature Branches
- **Purpose:** New features from contributors
- **Naming:** `feat/description` or `feat/ticket-description`
- **Lifespan:** Short (hours to days)
- **Target:** Merge to `next` via PR
- **Delete after:** Yes

### `agent/*` — AI-Generated Work
- **Purpose:** Code generated by AI agents
- **Naming:** `agent/agent-name-task`
- **Target:** Merge to `next` via PR
- **Special:** Extra review required for AI code

### `research/*` — Experimental
- **Purpose:** Spikes, prototypes, experiments
- **Naming:** `research/topic-name`
- **Target:** May merge to `next` if successful
- **Delete after:** Maybe (keep if reusable)

### `hotfix/*` — Emergency Fixes
- **Purpose:** Critical production fixes
- **Naming:** `hotfix/description`
- **Target:** PR directly to `main`
- **Must also:** Backport to `next`

---

## Workflow Examples

### Typical Feature Development

```bash
# Start from latest next
git checkout next
git pull

# Create feature branch
git checkout -b feat/add-octo-id-system

# Work, commit, push
git add .
git commit -m "feat: implement OCTO-ID generation"
git push -u origin feat/add-octo-id-system

# Create PR to next
gh pr create --base next --title "feat: Add OCTO-ID system"

# After approval, merge (squash)
# Delete branch locally and remotely
git branch -d feat/add-octo-id-system
```

### AI Agent Work

```bash
# Agent creates branch
git checkout -b agent/claude-refactor-runtime

# Agent commits with conventional commits
git commit -m "refactor(agent): simplify runtime initialization"

# Creates PR for human review
gh pr create --base next \
  --title "refactor: Simplify runtime initialization" \
  --body "AI-generated changes. Extra review appreciated."
```

### Hotfix to Production

```bash
# Start from main (the production state)
git checkout main
git pull

# Create hotfix branch
git checkout -b hotfix/fix-memory-leak

# Quick fix, test, push
git commit -m "fix: resolve memory leak in agent runtime"
git push -u origin hotfix/fix-memory-leak

# PR directly to main
gh pr create --base main --title "fix: Memory leak in runtime"

# After merge, ALSO merge to next
git checkout next
git cherry-pick <main-commit-hash>
git push
```

### Research Spike

```bash
# Research branch for experimentation
git checkout -b research/consensus-mechanisms

# Experimental commits (conventional commits optional)
git commit -m "spike: test Tendermint integration"

# If successful → PR to next
# If not → close branch, keep history
```

---

## Commit Convention

Use [Conventional Commits](https://www.conventionalcommits.org/):

```
<type>[optional scope]: <description>

[optional body]

[optional footer(s)]
```

**Types:**
- `feat` — New feature
- `fix` — Bug fix
- `refactor` — Code change without functional change
- `docs` — Documentation only
- `test` — Test additions/changes
- `chore` — Build, config, dependencies
- `perf` — Performance improvement
- `ci` — CI/CD changes
- `style` — Formatting (no logic change)

**Scopes (examples):**
- `runtime` — Agent runtime
- `blockchain` — Blockchain integration
- `cli` — Command-line tools
- `crypto` — Cryptographic operations
- `agent` — AI agent system

---

## Merge Policies

| To Branch | From | Method | Requirements |
|-----------|------|--------|--------------|
| `main` | `next` | Squash & Merge | All CI pass, 1+ approval |
| `main` | `hotfix/*` | Squash & Merge | All CI pass, 1+ approval |
| `next` | `feat/*` | Merge Commit | All CI pass |
| `next` | `agent/*` | Merge Commit | All CI pass, extra review |
| `next` | `research/*` | Merge Commit | All CI pass |
| Any | Any | Rebase | ❌ Never (rewrites history) |

---

## Branch Cleanup

### Automatic Deletion
Enable in GitHub: Settings → Branches → "Automatically delete head branches"

### Manual Cleanup
```bash
# List merged branches
git branch --merged

# Delete locally
git branch -d feat/finished-feature

# Delete remotely
git push origin --delete feat/finished-feature
```

### Protected Branches (Never Delete)
- `main`
- `next`
- `release/*` (if using release branches)

---

## FAQ

### Q: Can I push directly to `next`?
A: Yes, `next` allows direct push for rapid iteration. But `main` never does.

### Q: How do I get something to `main`?
A: Merge to `next` first, then PR `next` → `main`. Except for hotfixes.

### Q: What if my experiment fails?
A: Just close the `research/*` PR. The branch stays in history for reference.

### Q: Can AI agents commit to `main`?
A: No. AI agents work in `agent/*` branches and require human PR review.

### Q: How long can a `feat/*` branch live?
A: Keep it short (hours to days). Long-lived branches indicate need for `research/*`.

---

## Quick Reference

```
main    → PR only → always releasable
next    → PR/direct → integration lane
feat/*  → direct → contributor features
agent/* → direct → AI-generated work
research/* → direct → experiments
hotfix/* → PR to main → emergency fixes
```

Golden Rule: **Nobody pushes directly to main.**
